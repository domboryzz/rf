    // Function to capture image from video stream
    function captureImageFromVideo() {
      const video = document.querySelector('#scanner-container video');
      if (!video) return null;

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      return canvas.toDataURL('image/jpeg', 0.8);
    }

    // Function to convert base64 to blob for API
    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], {type: mime});
    }<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Rainforest Alliance Checker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      padding: 20px; 
      background: #f5f5f5; 
    }
    h1 { 
      margin-bottom: 10px; 
      color: #2c5f2d;
    }
    #scanner-container {
      width: 90%;
      max-width: 500px;
      margin: 20px auto;
      border: 2px solid #333;
      border-radius: 10px;
      overflow: hidden;
      min-height: 300px;
    }
    #barcode { 
      margin-top: 15px; 
      font-size: 1.2em; 
      min-height: 30px;
    }
    #result { 
      margin-top: 20px; 
      font-size: 2em; 
      font-weight: bold; 
      min-height: 60px;
    }
    .yes { color: green; }
    .no { color: red; }
    .loading { color: #666; }
    .error { color: #ff6b6b; }
    button {
      background: #2c5f2d;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #1e4220;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>SprawdÅº Rainforest Alliance Logo</h1>
  <div id="scanner-container"></div>
  <div>
    <button id="startBtn" onclick="startScanner()">Rozpocznij skanowanie</button>
    <button id="stopBtn" onclick="stopScanner()" disabled>Zatrzymaj skanowanie</button>
  </div>
  <div style="margin: 20px 0;">
    <input type="text" id="manualInput" placeholder="Lub wpisz kod produktu rÄ™cznie..." 
           style="padding: 10px; width: 300px; border: 2px solid #ccc; border-radius: 5px; font-size: 16px;">
    <button onclick="checkManualCode()" 
            style="background: #2c5f2d; color: white; border: none; padding: 10px 15px; margin-left: 10px; border-radius: 5px; cursor: pointer;">
      SprawdÅº kod
    </button>
  </div>
  <div id="barcode">NaciÅ›nij "Rozpocznij skanowanie" aby zaczÄ…Ä‡</div>
  <div id="result"></div>

  <script>
    let html5QrcodeScanner = null;
    let isScanning = false;
    let videoStream = null;
    
    const barcodeDiv = document.getElementById("barcode");
    const resultDiv = document.getElementById("result");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // Function to check both barcode and image with AI
    async function checkRainforestAlliance(code, imageData = null) {
      resultDiv.innerHTML = '<span class="loading">Sprawdzam z Google AI...</span>';
      
      try {
        console.log('Sprawdzam kod z Google AI:', code);
        
        let requestBody;
        
        if (imageData) {
          // Remove the data:image/jpeg;base64, prefix
          const base64Image = imageData.split(',')[1];
          
          requestBody = {
            contents: [{
              parts: [
                { text: `SprawdÅº ten kod kreskowy ${code} na zdjÄ™ciu:

1. Skoncentruj siÄ™ na kodzie kreskowym widocznym na zdjÄ™ciu
2. Jaka to marka i nazwa produktu?
3. Czy ten produkt posiada certyfikat Rainforest Alliance?
4. Przeszukaj internet aby to zweryfikowaÄ‡

Odpowiedz w formacie:
PRODUKT: [nazwa produktu i marka]
RAINFOREST ALLIANCE: TAK/NIE
[link lub opis gdzie moÅ¼na zobaczyÄ‡ logo lub certyfikat]` },
                {
                  inline_data: {
                    mime_type: "image/jpeg",
                    data: base64Image
                  }
                }
              ]
            }]
          };
        } else {
          requestBody = {
            contents: [{
              parts: [{
                text: `SprawdÅº kod ${code} (moÅ¼e byÄ‡ kod kreskowy lub numer produktu):

1. Jaka to marka i nazwa produktu?
2. Czy ten produkt posiada certyfikat Rainforest Alliance?
3. Przeszukaj internet aby to zweryfikowaÄ‡

Odpowiedz w formacie:
PRODUKT: [nazwa produktu i marka]
RAINFOREST ALLIANCE: TAK/NIE
[link lub opis gdzie moÅ¼na zobaczyÄ‡ logo lub certyfikat]`
              }]
            }]
          };
        }
        
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=AIzaSyDU9GAFN0h4c91k11Cf2bKhQ--SoNrKj0g", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        const answer = data?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (answer) {
          // Parse the response to extract product name and certification
          const lines = answer.split('\n').filter(line => line.trim());
          let productName = '';
          let certification = '';
          let info = '';

          for (let line of lines) {
            if (line.includes('PRODUKT:')) {
              productName = line.replace('PRODUKT:', '').trim();
            } else if (line.includes('RAINFOREST ALLIANCE:')) {
              certification = line.replace('RAINFOREST ALLIANCE:', '').trim();
            } else if (line.trim() && !line.includes(':') && !line.includes('SprawdÅº')) {
              info += line.trim() + ' ';
            }
          }

          let resultHTML = '';
          if (productName) {
            resultHTML += `<div style="font-size: 0.7em; margin-bottom: 15px; color: #666;">PRODUKT: ${productName}</div>`;
          }

          if (certification.toUpperCase().includes('TAK')) {
            resultHTML += `<span class="yes">TAK - Posiada certyfikat Rainforest Alliance</span>`;
          } else if (certification.toUpperCase().includes('NIE')) {
            resultHTML += '<span class="no">NIE - Brak certyfikatu Rainforest Alliance</span>';
          } else {
            resultHTML += '<span class="loading">Nie udaÅ‚o siÄ™ ustaliÄ‡ statusu certyfikacji</span>';
          }

          if (info.trim()) {
            resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #333;">${info.trim()}</div>`;
          }

          if (imageData) {
            resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #999;">ðŸ“¸ Analizowano ze zdjÄ™cia</div>`;
          }

          resultDiv.innerHTML = resultHTML;
        } else {
          resultDiv.innerHTML = '<span class="error">Brak odpowiedzi z API</span>';
        }

      } catch (error) {
        console.error('API Error:', error);
        
        // Fallback to mock response if API fails
        resultDiv.innerHTML = '<span class="loading">API niedostÄ™pne - uÅ¼ywam danych testowych...</span>';
        
        setTimeout(() => {
          const mockProducts = [
            { 
              name: "NestlÃ© KitKat", 
              hasLogo: true, 
              info: "Logo widoczne na opakowaniu z tyÅ‚u" 
            },
            { 
              name: "Coca-Cola", 
              hasLogo: false, 
              info: "" 
            },
            { 
              name: "Hershey's Dark Chocolate", 
              hasLogo: true, 
              info: "https://www.thehersheycompany.com/sustainability/cocoa-sustainability" 
            },
            { 
              name: "Mars Snickers", 
              hasLogo: true, 
              info: "Certyfikat widoczny na przedniej stronie opakowania" 
            }
          ];
          
          const randomProduct = mockProducts[Math.floor(Math.random() * mockProducts.length)];
          
          let resultHTML = `<div style="font-size: 0.7em; margin-bottom: 15px; color: #666;">PRODUKT: ${randomProduct.name} (dane testowe)</div>`;
          
          if (randomProduct.hasLogo) {
            resultHTML += `<span class="yes">TAK - Posiada certyfikat Rainforest Alliance</span>`;
            if (randomProduct.info) {
              resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #333;">${randomProduct.info}</div>`;
            }
          } else {
            resultHTML += '<span class="no">NIE - Brak certyfikatu Rainforest Alliance</span>';
          }
          
          if (imageData) {
            resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #999;">ðŸ“¸ Analizowano ze zdjÄ™cia (dane testowe)</div>`;
          }
          
          resultDiv.innerHTML = resultHTML;
        }, 1000);
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      console.log("Wykryto kod:", decodedText);
      
      barcodeDiv.textContent = `RobiÄ™ zdjÄ™cie kodu: ${decodedText}`;
      
      // Capture image from video stream
      const imageData = captureImageFromVideo();
      
      if (imageData) {
        barcodeDiv.textContent = `AnalizujÄ™ zdjÄ™cie kodu: ${decodedText}`;
        checkRainforestAlliance(decodedText, imageData);
      } else {
        barcodeDiv.textContent = `Znaleziono kod: ${decodedText}`;
        checkRainforestAlliance(decodedText);
      }
      
      stopScanner();
    }

    function checkManualCode() {
      const manualInput = document.getElementById('manualInput');
      const code = manualInput.value.trim();
      
      if (!code) {
        alert('ProszÄ™ wpisaÄ‡ kod produktu');
        return;
      }
      
      barcodeDiv.textContent = `Sprawdzam kod: ${code}`;
      checkRainforestAlliance(code);
      manualInput.value = '';
    }

    // Allow Enter key in manual input
    document.getElementById('manualInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkManualCode();
      }
    });

    function onScanFailure(error) {
      // Handle scan failures silently - this is normal during scanning
    }

    function startScanner() {
      try {
        barcodeDiv.textContent = "InicjalizujÄ™ skaner...";

        html5QrcodeScanner = new Html5QrcodeScanner(
          "scanner-container",
          { 
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.777778,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            preferredCamera: "environment"
          },
          false
        );

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        isScanning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        barcodeDiv.textContent = "SkanujÄ™ kod kreskowy...";
        
      } catch (err) {
        console.error('BÅ‚Ä…d skanera:', err);
        barcodeDiv.innerHTML = `<span class="error">BÅ‚Ä…d: ${err.message}</span>`;
        resultDiv.innerHTML = "";
        
        isScanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function stopScanner() {
      if (html5QrcodeScanner && isScanning) {
        html5QrcodeScanner.clear().catch(error => {
          console.error("Failed to clear html5QrcodeScanner.", error);
        });
      }
      
      isScanning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      barcodeDiv.textContent = "Skanowanie zatrzymane";
      resultDiv.innerHTML = "";
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isScanning) {
        stopScanner();
      }
    });

    // Clean up when page unloads
    window.addEventListener('beforeunload', () => {
      if (html5QrcodeScanner && isScanning) {
        html5QrcodeScanner.clear();
      }
    });
  </script>
</body>
</html>
