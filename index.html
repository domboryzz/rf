    // Global variables for detection accuracy
    let detectedCodes = [];
    let detectionCount = 0;<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Rainforest Alliance Checker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      padding: 20px; 
      background: #f5f5f5; 
    }
    h1 { 
      margin-bottom: 10px; 
      color: #2c5f2d;
    }
    #scanner-container {
      position: relative;
      width: 90%;
      max-width: 500px;
      margin: 20px auto;
      border: 2px solid #333;
      border-radius: 10px;
      overflow: hidden;
    }
    video { 
      width: 100%;
      height: auto;
      display: block;
    }
    #barcode { 
      margin-top: 15px; 
      font-size: 1.2em; 
      min-height: 30px;
    }
    #result { 
      margin-top: 20px; 
      font-size: 2em; 
      font-weight: bold; 
      min-height: 60px;
    }
    .yes { color: green; }
    .no { color: red; }
    .loading { color: #666; }
    .error { color: #ff6b6b; }
    button {
      background: #2c5f2d;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #1e4220;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Sprawdź Rainforest Alliance Logo</h1>
  <div id="scanner-container">
    <video id="video" autoplay muted playsinline></video>
  </div>
  <div>
    <button id="startBtn" onclick="startScanner()">Rozpocznij skanowanie</button>
    <button id="stopBtn" onclick="stopScanner()" disabled>Zatrzymaj skanowanie</button>
  </div>
  <div id="barcode">Naciśnij "Rozpocznij skanowanie" aby zacząć</div>
  <div id="result"></div>

  <script>
    let isScanning = false;
    
    const barcodeDiv = document.getElementById("barcode");
    const resultDiv = document.getElementById("result");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // Mock function - replace with actual API call when available
    async function checkRainforestAlliance(barcode) {
      resultDiv.innerHTML = '<span class="loading">Sprawdzam...</span>';
      
      const prompt = `Czy produkt o kodzie kreskowym ${barcode} posiada certyfikat Rainforest Alliance? 
      
Odpowiedz tylko "TAK" lub "NIE", a następnie jeśli TAK, dodaj link do strony producenta lub zdjęcie produktu gdzie widać logo Rainforest Alliance.

Format odpowiedzi:
TAK/NIE
[opcjonalnie: link lub opis gdzie można zobaczyć logo]`;
      
      console.log('Sprawdzam kod:', barcode);
      
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Mock response - in reality this would check against a database
      const responses = [
        { hasLogo: true, info: "https://example-producer.com/rainforest-certification" },
        { hasLogo: true, info: "Logo widoczne na opakowaniu z tyłu, obok składników" },
        { hasLogo: false, info: "" },
        { hasLogo: true, info: "https://rainforest-alliance.org/find-certified/product-search" }
      ];
      
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      
      if (randomResponse.hasLogo) {
        resultDiv.innerHTML = `
          <span class="yes">TAK - Posiada certyfikat Rainforest Alliance</span>
          ${randomResponse.info ? `<div style="margin-top: 10px; font-size: 0.8em; color: #333;">${randomResponse.info}</div>` : ''}
        `;
      } else {
        resultDiv.innerHTML = '<span class="no">NIE - Brak certyfikatu Rainforest Alliance</span>';
      }
    }

    async function startScanner() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Kamera nie jest obsługiwana w tej przeglądarce');
        }

                  barcodeDiv.textContent = "Inicjalizuję skaner...";
          detectedCodes = [];
          detectionCount = 0;
        
        Quagga.init({
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner-container'),
            constraints: {
              width: 640,
              height: 480,
              facingMode: "environment" // Use back camera
            }
          },
          locator: {
            patchSize: "medium",
            halfSample: true
          },
          numOfWorkers: 2,
          decoder: {
            readers: [
              "code_128_reader",
              "ean_reader",
              "ean_8_reader",
              "code_39_reader",
              "code_39_vin_reader",
              "codabar_reader",
              "upc_reader",
              "upc_e_reader"
            ]
          },
          locate: true
        }, function(err) {
          if (err) {
            console.error('Błąd inicjalizacji Quagga:', err);
            barcodeDiv.innerHTML = `<span class="error">Błąd kamery: ${err.message}</span>`;
            return;
          }
          
          console.log("Quagga zainicjalizowane");
          Quagga.start();
          
          isScanning = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;
          barcodeDiv.textContent = "Skanuję kod kreskowy...";
        });

        // Store detected codes to verify accuracy
        let detectedCodes = [];
        let detectionCount = 0;

        Quagga.onDetected(function(result) {
        Quagga.onDetected(function(result) {
          const code = result.codeResult.code;
          console.log("Wykryto kod kreskowy:", code);
          
          // Add to detection array for verification
          detectedCodes.push(code);
          detectionCount++;
          
          barcodeDiv.textContent = `Weryfikuję kod... (${detectionCount}/3)`;
          
          // Wait for 3 consistent readings or 5 total readings
          if (detectionCount >= 3) {
            // Find the most common code
            const codeCounts = {};
            detectedCodes.forEach(c => {
              codeCounts[c] = (codeCounts[c] || 0) + 1;
            });
            
            // Get the code that appears most frequently
            const mostCommonCode = Object.keys(codeCounts).reduce((a, b) => 
              codeCounts[a] > codeCounts[b] ? a : b
            );
            
            // If the most common code appears at least twice, use it
            if (codeCounts[mostCommonCode] >= 2) {
              barcodeDiv.textContent = `Znaleziono kod: ${mostCommonCode}`;
              checkRainforestAlliance(mostCommonCode);
              
              // Stop scanning after detection
              Quagga.stop();
              isScanning = false;
              startBtn.disabled = false;
              stopBtn.disabled = true;
            } else if (detectionCount >= 5) {
              // If we can't get consistent readings after 5 attempts, use the last one
              barcodeDiv.textContent = `Znaleziono kod: ${code} (niespójne odczyty)`;
              checkRainforestAlliance(code);
              
              Quagga.stop();
              isScanning = false;
              startBtn.disabled = false;
              stopBtn.disabled = true;
            }
          }
        });
        
      } catch (err) {
        console.error('Błąd skanera:', err);
        barcodeDiv.innerHTML = `<span class="error">Błąd: ${err.message}</span>`;
        resultDiv.innerHTML = "";
        
        isScanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function stopScanner() {
      if (isScanning) {
        Quagga.stop();
      }
      
      // Reset detection arrays
      detectedCodes = [];
      detectionCount = 0;
      
      isScanning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      barcodeDiv.textContent = "Skanowanie zatrzymane";
      resultDiv.innerHTML = "";
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isScanning) {
        stopScanner();
      }
    });

    // Clean up when page unloads
    window.addEventListener('beforeunload', () => {
      if (isScanning) {
        Quagga.stop();
      }
    });
  </script>
</body>
</html>
