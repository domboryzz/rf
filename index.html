<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rainforest Alliance Checker</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      padding: 20px; 
      background: #f5f5f5; 
    }
    h1 { 
      margin-bottom: 10px; 
      color: #2c5f2d;
    }
    #reader {
      width: 90%;
      max-width: 500px;
      margin: 20px auto;
      border: 2px solid #333;
      border-radius: 10px;
      overflow: hidden;
    }
    #barcode { 
      margin-top: 15px; 
      font-size: 1.2em; 
      min-height: 30px;
    }
    #result { 
      margin-top: 20px; 
      font-size: 2em; 
      font-weight: bold; 
      min-height: 60px;
    }
    .yes { color: green; }
    .no { color: red; }
    .loading { color: #666; }
    .error { color: #ff6b6b; }
    button {
      background: #2c5f2d;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #1e4220;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    input[type="text"] {
      padding: 10px;
      width: 300px;
      border: 2px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Sprawdź Rainforest Alliance Logo</h1>
  <div id="reader"></div>
  <div>
    <button id="startBtn" onclick="startScanner()">Rozpocznij skanowanie</button>
    <button id="stopBtn" onclick="stopScanner()" disabled>Zatrzymaj skanowanie</button>
  </div>
  <div style="margin: 20px 0;">
    <input type="text" id="manualInput" placeholder="Lub wpisz kod produktu ręcznie..." maxlength="20">
    <button onclick="checkManualCode()">Sprawdź kod</button>
  </div>
  <div id="barcode">Naciśnij "Rozpocznij skanowanie" lub wpisz kod ręcznie</div>
  <div id="result"></div>

  <script>
    let html5QrCode = null;
    let isScanning = false;
    
    const barcodeDiv = document.getElementById("barcode");
    const resultDiv = document.getElementById("result");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // Function to check with Gemini AI
    async function checkRainforestAlliance(code) {
      resultDiv.innerHTML = '<span class="loading">Sprawdzam z Google AI...</span>';
      
      const prompt = `Sprawdź kod ${code} (może być kod kreskowy lub numer produktu):

1. Jaka to marka i nazwa produktu?
2. Czy ten produkt posiada certyfikat Rainforest Alliance?
3. Przeszukaj internet aby to zweryfikować

Odpowiedz w formacie:
PRODUKT: [nazwa produktu i marka]
RAINFOREST ALLIANCE: TAK/NIE
[link lub opis gdzie można zobaczyć logo lub certyfikat]`;
      
      try {
        console.log('Sprawdzam kod z Google AI:', code);
        
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=AIzaSyDU9GAFN0h4c91k11Cf2bKhQ--SoNrKj0g", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        const answer = data?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (answer) {
          // Parse the response to extract product name and certification
          const lines = answer.split('\n').filter(line => line.trim());
          let productName = '';
          let certification = '';
          let info = '';

          for (let line of lines) {
            if (line.includes('PRODUKT:')) {
              productName = line.replace('PRODUKT:', '').trim();
            } else if (line.includes('RAINFOREST ALLIANCE:')) {
              certification = line.replace('RAINFOREST ALLIANCE:', '').trim();
            } else if (line.trim() && !line.includes(':') && !line.includes('Sprawdź')) {
              info += line.trim() + ' ';
            }
          }

          let resultHTML = '';
          if (productName) {
            resultHTML += `<div style="font-size: 0.7em; margin-bottom: 15px; color: #666;">PRODUKT: ${productName}</div>`;
          }

          if (certification.toUpperCase().includes('TAK')) {
            resultHTML += `<span class="yes">TAK - Posiada certyfikat Rainforest Alliance</span>`;
          } else if (certification.toUpperCase().includes('NIE')) {
            resultHTML += '<span class="no">NIE - Brak certyfikatu Rainforest Alliance</span>';
          } else {
            resultHTML += '<span class="loading">Nie udało się ustalić statusu certyfikacji</span>';
          }

          if (info.trim()) {
            resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #333;">${info.trim()}</div>`;
          }

          resultDiv.innerHTML = resultHTML;
        } else {
          resultDiv.innerHTML = '<span class="error">Brak odpowiedzi z API</span>';
        }

      } catch (error) {
        console.error('API Error:', error);
        
        // Fallback to mock response if API fails
        resultDiv.innerHTML = '<span class="loading">API niedostępne - używam danych testowych...</span>';
        
        setTimeout(() => {
          const mockProducts = [
            { 
              name: "Nestlé KitKat", 
              hasLogo: true, 
              info: "Logo widoczne na opakowaniu z tyłu" 
            },
            { 
              name: "Coca-Cola", 
              hasLogo: false, 
              info: "" 
            },
            { 
              name: "Hershey's Dark Chocolate", 
              hasLogo: true, 
              info: "https://www.thehersheycompany.com/sustainability/cocoa-sustainability" 
            },
            { 
              name: "Mars Snickers", 
              hasLogo: true, 
              info: "Certyfikat widoczny na przedniej stronie opakowania" 
            }
          ];
          
          const randomProduct = mockProducts[Math.floor(Math.random() * mockProducts.length)];
          
          let resultHTML = `<div style="font-size: 0.7em; margin-bottom: 15px; color: #666;">PRODUKT: ${randomProduct.name} (dane testowe)</div>`;
          
          if (randomProduct.hasLogo) {
            resultHTML += `<span class="yes">TAK - Posiada certyfikat Rainforest Alliance</span>`;
            if (randomProduct.info) {
              resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #333;">${randomProduct.info}</div>`;
            }
          } else {
            resultHTML += '<span class="no">NIE - Brak certyfikatu Rainforest Alliance</span>';
          }
          
          resultDiv.innerHTML = resultHTML;
        }, 1000);
      }
    }

    function startScanner() {
      if (html5QrCode && isScanning) {
        stopScanner();
        return;
      }

      html5QrCode = new Html5Qrcode("reader");
      
      html5QrCode.start(
        { facingMode: "environment" }, // Use back camera
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          console.log("Wykryto kod:", decodedText);
          barcodeDiv.textContent = `Znaleziono kod: ${decodedText}`;
          checkRainforestAlliance(decodedText);
          html5QrCode.stop();
          isScanning = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
        },
        (errorMessage) => {
          // Log errors silently
          console.warn("Scanning error:", errorMessage);
        }
      ).then(() => {
        isScanning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        barcodeDiv.textContent = "Skanuję kod kreskowy...";
      }).catch((err) => {
        console.error("Error starting scanner:", err);
        barcodeDiv.innerHTML = `<span class="error">Błąd kamery: ${err.message}</span>`;
        isScanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      });
    }

    function stopScanner() {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
          isScanning = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
          barcodeDiv.textContent = "Skanowanie zatrzymane";
          resultDiv.innerHTML = "";
        }).catch((err) => {
          console.error("Error stopping scanner:", err);
        });
      }
    }

    function checkManualCode() {
      const manualInput = document.getElementById('manualInput');
      const code = manualInput.value.trim();
      
      if (!code) {
        alert('Proszę wpisać kod produktu');
        return;
      }
      
      barcodeDiv.textContent = `Sprawdzam kod: ${code}`;
      checkRainforestAlliance(code);
      manualInput.value = '';
    }

    // Allow Enter key in manual input
    document.getElementById('manualInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkManualCode();
      }
    });

    // Handle page visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isScanning) {
        stopScanner();
      }
    });

    // Clean up when page unloads
    window.addEventListener('beforeunload', () => {
      if (html5QrCode && isScanning) {
        html5QrCode.stop();
      }
    });
  </script>
</body>
</html>
