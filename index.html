<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Rainforest Alliance Checker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      padding: 20px; 
      background: #f5f5f5; 
    }
    h1 { 
      margin-bottom: 10px; 
      color: #2c5f2d;
    }
    #scanner-container {
      width: 90%;
      max-width: 500px;
      margin: 20px auto;
      border: 2px solid #333;
      border-radius: 10px;
      overflow: hidden;
      min-height: 300px;
    }
    #barcode { 
      margin-top: 15px; 
      font-size: 1.2em; 
      min-height: 30px;
    }
    #result { 
      margin-top: 20px; 
      font-size: 2em; 
      font-weight: bold; 
      min-height: 60px;
    }
    .yes { color: green; }
    .no { color: red; }
    .loading { color: #666; }
    .error { color: #ff6b6b; }
    button {
      background: #2c5f2d;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #1e4220;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Sprawdź Rainforest Alliance Logo</h1>
  <div id="scanner-container"></div>
  <div>
    <button id="startBtn" onclick="startScanner()">Rozpocznij skanowanie</button>
    <button id="stopBtn" onclick="stopScanner()" disabled>Zatrzymaj skanowanie</button>
  </div>
  <div id="barcode">Naciśnij "Rozpocznij skanowanie" aby zacząć</div>
  <div id="result"></div>

  <script>
    let html5QrcodeScanner = null;
    let isScanning = false;
    
    const barcodeDiv = document.getElementById("barcode");
    const resultDiv = document.getElementById("result");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // Mock function - replace with actual API call when available
    async function checkRainforestAlliance(barcode) {
      resultDiv.innerHTML = '<span class="loading">Sprawdzam...</span>';
      
      const prompt = `Sprawdź kod kreskowy ${barcode}:

1. Jaka to marka i nazwa produktu?
2. Czy ten produkt posiada certyfikat Rainforest Alliance?

Odpowiedz w formacie:
PRODUKT: [nazwa produktu i marka]
RAINFOREST ALLIANCE: TAK/NIE
[opcjonalnie: link lub opis gdzie można zobaczyć logo]`;
      
      console.log('Sprawdzam kod:', barcode);
      
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Mock response - in reality this would check against a database
      const mockProducts = [
        { 
          name: "Nestlé KitKat", 
          hasLogo: true, 
          info: "Logo widoczne na opakowaniu z tyłu" 
        },
        { 
          name: "Coca-Cola", 
          hasLogo: false, 
          info: "" 
        },
        { 
          name: "Hershey's Dark Chocolate", 
          hasLogo: true, 
          info: "https://www.thehersheycompany.com/en_us/responsibility/good-business/creating-goodness/sustainable-sourcing.html" 
        },
        { 
          name: "Mars Snickers", 
          hasLogo: true, 
          info: "Certyfikat widoczny na przedniej stronie opakowania" 
        },
        { 
          name: "Unilever Ben & Jerry's", 
          hasLogo: false, 
          info: "" 
        }
      ];
      
      const randomProduct = mockProducts[Math.floor(Math.random() * mockProducts.length)];
      
      let resultHTML = `<div style="font-size: 0.7em; margin-bottom: 15px; color: #666;">PRODUKT: ${randomProduct.name}</div>`;
      
      if (randomProduct.hasLogo) {
        resultHTML += `<span class="yes">TAK - Posiada certyfikat Rainforest Alliance</span>`;
        if (randomProduct.info) {
          resultHTML += `<div style="margin-top: 10px; font-size: 0.6em; color: #333;">${randomProduct.info}</div>`;
        }
      } else {
        resultHTML += '<span class="no">NIE - Brak certyfikatu Rainforest Alliance</span>';
      }
      
      resultDiv.innerHTML = resultHTML;
    }

    function onScanSuccess(decodedText, decodedResult) {
      console.log("Wykryto kod:", decodedText);
      
      barcodeDiv.textContent = `Znaleziono kod: ${decodedText}`;
      checkRainforestAlliance(decodedText);
      stopScanner();
    }

    function onScanFailure(error) {
      // Handle scan failures silently - this is normal during scanning
    }

    function startScanner() {
      try {
        barcodeDiv.textContent = "Inicjalizuję skaner...";

        html5QrcodeScanner = new Html5QrcodeScanner(
          "scanner-container",
          { 
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.777778,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            preferredCamera: "environment"
          },
          false
        );

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        isScanning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        barcodeDiv.textContent = "Skanuję kod kreskowy...";
        
      } catch (err) {
        console.error('Błąd skanera:', err);
        barcodeDiv.innerHTML = `<span class="error">Błąd: ${err.message}</span>`;
        resultDiv.innerHTML = "";
        
        isScanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function stopScanner() {
      if (html5QrcodeScanner && isScanning) {
        html5QrcodeScanner.clear().catch(error => {
          console.error("Failed to clear html5QrcodeScanner.", error);
        });
      }
      
      isScanning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      barcodeDiv.textContent = "Skanowanie zatrzymane";
      resultDiv.innerHTML = "";
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isScanning) {
        stopScanner();
      }
    });

    // Clean up when page unloads
    window.addEventListener('beforeunload', () => {
      if (html5QrcodeScanner && isScanning) {
        html5QrcodeScanner.clear();
      }
    });
  </script>
</body>
</html>
